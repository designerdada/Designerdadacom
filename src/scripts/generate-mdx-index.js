/**
 * Build script to automatically generate /content/writing/index.ts
 * from all MDX files in /content/writing/
 * 
 * Run this before build: node scripts/generate-mdx-index.js
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const CONTENT_DIR = path.join(__dirname, '../content/writing');
const OUTPUT_FILE = path.join(CONTENT_DIR, 'index.ts');

function toCamelCase(str) {
  return str
    .split('-')
    .map((word, index) => 
      index === 0 
        ? word 
        : word.charAt(0).toUpperCase() + word.slice(1)
    )
    .join('');
}

function generateIndexFile() {
  console.log('üîç Scanning for MDX files...');
  
  // Read all files in the content/writing directory
  const files = fs.readdirSync(CONTENT_DIR)
    .filter(file => 
      file.endsWith('.mdx') && 
      !file.startsWith('_') // Ignore template files
    );

  if (files.length === 0) {
    console.log('‚ö†Ô∏è  No MDX files found in /content/writing/');
    return;
  }

  console.log(`üìù Found ${files.length} article(s):`);
  files.forEach(file => console.log(`   - ${file}`));

  const exports = [];
  const mappings = [];

  files.forEach(file => {
    const slug = path.basename(file, '.mdx');
    const varName = toCamelCase(slug);
    const filePath = path.join(CONTENT_DIR, file);
    const content = fs.readFileSync(filePath, 'utf-8');

    // Escape backticks and ${} in content
    const escapedContent = content
      .replace(/\\/g, '\\\\')
      .replace(/`/g, '\\`')
      .replace(/\$/g, '\\$');

    exports.push(`export const ${varName} = \`${escapedContent}\`;`);
    mappings.push(`  '${slug}': ${varName},`);
  });

  const output = `// This file is auto-generated by scripts/generate-mdx-index.js
// Do not edit manually - your changes will be overwritten!
// To add a new article, create a .mdx file in /content/writing/ and run: npm run generate-mdx

${exports.join('\n\n')}

// Map of all articles
export const allMDXContent: Record<string, string> = {
${mappings.join('\n')}
};
`;

  fs.writeFileSync(OUTPUT_FILE, output, 'utf-8');
  console.log(`‚úÖ Generated ${OUTPUT_FILE}`);
  console.log(`üì¶ Exported ${files.length} article(s) to index.ts`);
}

try {
  generateIndexFile();
} catch (error) {
  console.error('‚ùå Error generating MDX index:', error);
  process.exit(1);
}
